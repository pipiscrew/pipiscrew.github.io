<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.6.2"><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="send mail through Gmail API" /><meta name="author" content="PipisCrew" /><meta property="og:locale" content="en_US" /><meta name="description" content="reference howto - http://developers.google.com/gmail/api/auth/web-server code snippet - http://stackoverflow.com/q/26627755 code snippet - http://github.com/google/google-api-php-client/issues/376 code snippet - http://stackoverflow.com/questions/28122074/gmail-api-emails-bouncing Users.messages-&gt; send - http://developers.google.com/gmail/api/v1/reference/users/messages/send" /><meta property="og:description" content="reference howto - http://developers.google.com/gmail/api/auth/web-server code snippet - http://stackoverflow.com/q/26627755 code snippet - http://github.com/google/google-api-php-client/issues/376 code snippet - http://stackoverflow.com/questions/28122074/gmail-api-emails-bouncing Users.messages-&gt; send - http://developers.google.com/gmail/api/v1/reference/users/messages/send" /><link rel="canonical" href="/posts/send-mail/" /><meta property="og:url" content="/posts/send-mail/" /><meta property="og:site_name" content="PipisCrew" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-02-25T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="send mail through Gmail API" /><meta name="twitter:site" content="@pipiscrew" /><meta name="twitter:creator" content="@PipisCrew" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"/posts/send-mail/","headline":"send mail through Gmail API","dateModified":"2017-02-25T00:00:00+08:00","datePublished":"2017-02-25T00:00:00+08:00","author":{"@type":"Person","name":"PipisCrew"},"mainEntityOfPage":{"@type":"WebPage","@id":"/posts/send-mail/"},"description":"reference howto - http://developers.google.com/gmail/api/auth/web-server code snippet - http://stackoverflow.com/q/26627755 code snippet - http://github.com/google/google-api-php-client/issues/376 code snippet - http://stackoverflow.com/questions/28122074/gmail-api-emails-bouncing Users.messages-&gt; send - http://developers.google.com/gmail/api/v1/reference/users/messages/send","@context":"https://schema.org"}</script><title>send mail through Gmail API | PipisCrew</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/sample/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">PipisCrew</a></div><div class="site-subtitle font-italic">A text-focused Jekyll theme.</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/pipiscrew" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/pipiscrew" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>send mail through Gmail API</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>send mail through Gmail API</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Feb 25, 2017, 12:00 AM +0800" > Feb 25, 2017 <i class="unloaded">2017-02-25T00:00:00+08:00</i> </span> by <span class="author"> PipisCrew </span></div></div><div class="post-content"><p>reference howto - <a href="http://developers.google.com/gmail/api/auth/web-server">http://developers.google.com/gmail/api/auth/web-server</a> code snippet - <a href="http://stackoverflow.com/q/26627755">http://stackoverflow.com/q/26627755</a> code snippet - <a href="http://github.com/google/google-api-php-client/issues/376">http://github.com/google/google-api-php-client/issues/376</a> code snippet - <a href="http://stackoverflow.com/questions/28122074/gmail-api-emails-bouncing">http://stackoverflow.com/questions/28122074/gmail-api-emails-bouncing</a> Users.messages-&gt; send - <a href="http://developers.google.com/gmail/api/v1/reference/users/messages/send">http://developers.google.com/gmail/api/v1/reference/users/messages/send</a></p><hr /><p>similar - Manipulate Calendar through Google API - <a href="https://www.pipiscrew.com/2015/05/php-manipulate-calendar-through-google-api/">https://www.pipiscrew.com/2015/05/php-manipulate-calendar-through-google-api/</a></p><blockquote><p>BlueHost blocked the feature to send mail by another SMTP (PHPMailer no working etc.)</p><p>SOLUTION is one! Use GMAIL API!!!</p></blockquote><p>-as 01/04/2015 -goto <a href="http://console.developers.google.com/">http://console.developers.google.com/</a> -select a project, or create a new one. In the sidebar on the left, expand APIs &amp; auth. Next, click APIs. In the list of APIs, enable Gmail API.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://www.pipiscrew.com/wp-content/uploads/2015/04/snap602.png" alt="" title="snap602" /></p><p>-in the sidebar on the left, select Credentials &gt; OAuth - Create new Client ID, setup as :</p><p><a href="https://www.pipiscrew.com/wp-content/uploads/2015/04/snap603.png"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://www.pipiscrew.com/wp-content/uploads/2015/04/snap603.png" alt="" title="snap603" /></a></p><p>-now we have Client ID + Client secret thats great!</p><p>-download <a href="http://github.com/google/google-api-php-client">http://github.com/google/google-api-php-client</a> ZIP -goto http://x.com/pipis2/ extract the folder <strong>Google</strong> that is inside google-api-php-client-master.zip\google-api-php-client-master\src, so no we have</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://www.pipiscrew.com/wp-content/uploads/2015/04/snap605.png" alt="" title="snap605" /></p><p>-create an index.php and paste :</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
</pre><td class="rouge-code"><pre><span class="c1">//index.php gmail api send mail</span>
<span class="c1">//code is dirty but working!</span>
<span class="o">&lt;</span><span class="p">?</span><span class="nx">php</span> <span class="nx">session_start</span><span class="p">();</span><span class="o">=</span><span class="dl">""</span> <span class="nx">require_once</span><span class="o">=</span><span class="dl">""</span> <span class="dl">'</span><span class="s1">google/autoload.php</span><span class="dl">'</span><span class="p">;</span><span class="o">=</span><span class="dl">""</span> <span class="nx">or</span><span class="o">=</span><span class="dl">""</span> <span class="nx">wherever</span><span class="o">=</span><span class="dl">""</span> <span class="nx">autoload</span><span class="p">.</span><span class="nx">php</span><span class="o">=</span><span class="dl">""</span> <span class="nx">is</span><span class="o">=</span><span class="dl">""</span> <span class="nx">located</span><span class="o">=</span><span class="dl">""</span> <span class="nx">$client</span><span class="o">=</span><span class="dl">"</span><span class="s2">new</span><span class="dl">"</span> <span class="nx">google_client</span><span class="p">();</span><span class="o">=</span><span class="dl">""</span> <span class="nx">$client</span><span class="o">-=</span><span class="dl">""</span><span class="p">?</span><span class="o">&gt;</span><span class="nx">setClientId</span><span class="p">(</span><span class="dl">"</span><span class="s2">x-x.apps.googleusercontent.com</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setClientSecret</span><span class="p">(</span><span class="dl">"</span><span class="s2">xyxyxyxyxy</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setRedirectUri</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://x.com/pipis2/</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setAccessType</span><span class="p">(</span><span class="dl">'</span><span class="s1">offline</span><span class="dl">'</span><span class="p">);</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setApprovalPrompt</span><span class="p">(</span><span class="dl">'</span><span class="s1">force</span><span class="dl">'</span><span class="p">);</span>

	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://mail.google.com/</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.googleapis.com/auth/gmail.compose</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.googleapis.com/auth/gmail.modify</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.googleapis.com/auth/gmail.readonly</span><span class="dl">"</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nx">$_REQUEST</span><span class="p">[</span><span class="dl">'</span><span class="s1">code</span><span class="dl">'</span><span class="p">]))</span> <span class="p">{</span>
	<span class="c1">//land when user authenticated</span>
	<span class="nx">$code</span> <span class="o">=</span> <span class="nx">$_REQUEST</span><span class="p">[</span><span class="dl">'</span><span class="s1">code</span><span class="dl">'</span><span class="p">];</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">authenticate</span><span class="p">(</span><span class="nx">$code</span><span class="p">);</span>

	<span class="nx">$_SESSION</span><span class="p">[</span><span class="dl">'</span><span class="s1">gmail_access_token</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">getAccessToken</span><span class="p">();</span>

	<span class="nx">header</span><span class="p">(</span><span class="dl">"</span><span class="s2">Location: https://x.com/pipis2/</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//$isAccessCodeExpired = $client-&gt;isAccessTokenExpired();</span>

<span class="c1">//if (isset($_SESSION['gmail_access_token']) &amp;&amp; !empty($_SESSION['gmail_access_token']) &amp;&amp; $isAccessCodeExpired != 1) {</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nx">$_SESSION</span><span class="p">[</span><span class="dl">'</span><span class="s1">gmail_access_token</span><span class="dl">'</span><span class="p">]))</span> <span class="p">{</span>
	<span class="c1">//gmail_access_token setted;</span>

	<span class="nx">$boundary</span> <span class="o">=</span> <span class="nx">uniqid</span><span class="p">(</span><span class="nx">rand</span><span class="p">(),</span> <span class="kc">true</span><span class="p">);</span>

    <span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setAccessToken</span><span class="p">(</span><span class="nx">$_SESSION</span><span class="p">[</span><span class="dl">'</span><span class="s1">gmail_access_token</span><span class="dl">'</span><span class="p">]);</span>            
    <span class="nx">$objGMail</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Google_Service_Gmail</span><span class="p">(</span><span class="nx">$client</span><span class="p">);</span>

    <span class="nx">$subjectCharset</span> <span class="o">=</span> <span class="nx">$charset</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">utf-8</span><span class="dl">'</span><span class="p">;</span>
    <span class="nx">$strToMailName</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">To User Name</span><span class="dl">'</span><span class="p">;</span>
    <span class="nx">$strToMail</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">yourmail@yourmail@93.com</span><span class="dl">'</span><span class="p">;</span>
    <span class="nx">$strSesFromName</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">From User Name</span><span class="dl">'</span><span class="p">;</span>
    <span class="nx">$strSesFromEmail</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">yourmail@yourmail@93.com</span><span class="dl">'</span><span class="p">;</span>
    <span class="nx">$strSubject</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Test mail using GMail API</span><span class="dl">'</span> <span class="p">.</span> <span class="nx">date</span><span class="p">(</span><span class="dl">'</span><span class="s1">M d, Y h:i:s A</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">'</span><span class="s1">To: </span><span class="dl">'</span> <span class="p">.</span> <span class="nx">encodeRecipients</span><span class="p">(</span><span class="nx">$strToMailName</span> <span class="p">.</span> <span class="dl">"</span><span class="s2"> &lt;</span><span class="dl">"</span> <span class="p">.</span><span class="o">=</span><span class="dl">""</span> <span class="nx">$strtomail</span><span class="o">=</span><span class="dl">""</span> <span class="p">.</span><span class="o">=</span><span class="dl">""</span> <span class="dl">"</span><span class="s2">=</span><span class="dl">""</span><span class="s2">&gt;</span><span class="dl">"</span><span class="p">)</span> <span class="p">.</span> <span class="dl">"</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">'</span><span class="s1">From: </span><span class="dl">'</span><span class="p">.</span> <span class="nx">encodeRecipients</span><span class="p">(</span><span class="nx">$strSesFromName</span> <span class="p">.</span> <span class="dl">"</span><span class="s2"> &lt;</span><span class="dl">"</span> <span class="p">.</span><span class="o">=</span><span class="dl">""</span> <span class="nx">$strsesfromemail</span><span class="o">=</span><span class="dl">""</span> <span class="p">.</span><span class="o">=</span><span class="dl">""</span> <span class="dl">"</span><span class="s2">=</span><span class="dl">""</span><span class="s2">&gt;</span><span class="dl">"</span><span class="p">)</span> <span class="p">.</span> <span class="dl">"</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>

    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">'</span><span class="s1">Subject: =?</span><span class="dl">'</span> <span class="p">.</span> <span class="nx">$subjectCharset</span> <span class="p">.</span> <span class="dl">'</span><span class="s1">?B?</span><span class="dl">'</span> <span class="p">.</span> <span class="nx">base64_encode</span><span class="p">(</span><span class="nx">$strSubject</span><span class="p">)</span> <span class="p">.</span> <span class="dl">"</span><span class="s2">?=</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">'</span><span class="s1">MIME-Version: 1.0</span><span class="dl">'</span> <span class="p">.</span> <span class="dl">"</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">'</span><span class="s1">Content-type: Multipart/Alternative; boundary="</span><span class="dl">'</span> <span class="p">.</span> <span class="nx">$boundary</span> <span class="p">.</span> <span class="dl">'</span><span class="s1">"</span><span class="dl">'</span> <span class="p">.</span> <span class="dl">"</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>

<span class="c1">// 	$strRawMessage .= "\r\n--{$boundary}\r\n";</span>
<span class="c1">//    $strRawMessage .= 'Content-Type: '. $mimeType .'; name="'. $fileName .'";' . "\r\n";            </span>
<span class="c1">//    $strRawMessage .= 'Content-ID: &lt;' .="" $strsesfromemail="" .="" '=""&gt;' . "\r\n";            </span>
<span class="c1">//    $strRawMessage .= 'Content-Description: ' . $fileName . ';' . "\r\n";</span>
<span class="c1">//    $strRawMessage .= 'Content-Disposition: attachment; filename="' . $fileName . '"; size=' . filesize($filePath). ';' . "\r\n";</span>
<span class="c1">//    $strRawMessage .= 'Content-Transfer-Encoding: base64' . "\r\n\r\n";</span>
<span class="c1">//    $strRawMessage .= chunk_split(base64_encode(file_get_contents($filePath)), 76, "\n") . "\r\n";</span>
<span class="c1">//    $strRawMessage .= '--' . $boundary . "\r\n";</span>

    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">"</span><span class="se">\r\n</span><span class="s2">--{$boundary}</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">'</span><span class="s1">Content-Type: text/plain; charset=</span><span class="dl">'</span> <span class="p">.</span> <span class="nx">$charset</span> <span class="p">.</span> <span class="dl">"</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">'</span><span class="s1">Content-Transfer-Encoding: 7bit</span><span class="dl">'</span> <span class="p">.</span> <span class="dl">"</span><span class="se">\r\n\r\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">"</span><span class="s2">this is a test!</span><span class="dl">"</span> <span class="p">.</span> <span class="dl">"</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>

    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">"</span><span class="s2">--{$boundary}</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">'</span><span class="s1">Content-Type: text/html; charset=</span><span class="dl">'</span> <span class="p">.</span> <span class="nx">$charset</span> <span class="p">.</span> <span class="dl">"</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">'</span><span class="s1">Content-Transfer-Encoding: quoted-printable</span><span class="dl">'</span> <span class="p">.</span> <span class="dl">"</span><span class="se">\r\n\r\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">"</span><span class="s2">this is a tes2t!</span><span class="dl">"</span> <span class="p">.</span> <span class="dl">"</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>

    <span class="c1">//Send Mails</span>
    <span class="c1">//Prepare the message in message/rfc822</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// The message needs to be encoded in Base64URL</span>
        <span class="nx">$mime</span> <span class="o">=</span> <span class="nx">rtrim</span><span class="p">(</span><span class="nx">strtr</span><span class="p">(</span><span class="nx">base64_encode</span><span class="p">(</span><span class="nx">$strRawMessage</span><span class="p">),</span> <span class="dl">'</span><span class="s1">+/</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">-_</span><span class="dl">'</span><span class="p">),</span> <span class="dl">'</span><span class="s1">=</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">$msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Google_Service_Gmail_Message</span><span class="p">();</span>
        <span class="nx">$msg</span><span class="o">-&gt;</span><span class="nx">setRaw</span><span class="p">(</span><span class="nx">$mime</span><span class="p">);</span>
        <span class="nx">$objSentMsg</span> <span class="o">=</span> <span class="nx">$objGMail</span><span class="o">-&gt;</span><span class="nx">users_messages</span><span class="o">-&gt;</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">me</span><span class="dl">"</span><span class="p">,</span> <span class="nx">$msg</span><span class="p">);</span>

        <span class="nx">print</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message sent object</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">print</span><span class="p">(</span><span class="nx">$objSentMsg</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">$e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">print</span><span class="p">(</span><span class="nx">$e</span><span class="o">-&gt;</span><span class="nx">getMessage</span><span class="p">());</span>
        <span class="nx">unset</span><span class="p">(</span><span class="nx">$_SESSION</span><span class="p">[</span><span class="dl">'</span><span class="s1">gmail_access_token</span><span class="dl">'</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Failed Authentication</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nx">$_REQUEST</span><span class="p">[</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="c1">//header('Location: ./index.php?error_code=1');</span>
        <span class="nx">echo</span> <span class="dl">"</span><span class="s2">error auth</span><span class="dl">"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="c1">// Redirects to google for User Authentication</span>
        <span class="nx">$authUrl</span> <span class="o">=</span> <span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">createAuthUrl</span><span class="p">();</span>
        <span class="nx">header</span><span class="p">(</span><span class="dl">"</span><span class="s2">Location: $authUrl</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">encodeRecipients</span><span class="p">(</span><span class="nx">$recipient</span><span class="p">){</span>
    <span class="nx">$recipientsCharset</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">utf-8</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">preg_match</span><span class="p">(</span><span class="dl">"</span><span class="s2">/(.*)&lt;(.*)&gt;/</span><span class="dl">"</span><span class="p">,</span> <span class="nx">$recipient</span><span class="p">,</span> <span class="nx">$regs</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">$recipient</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">=?</span><span class="dl">'</span> <span class="p">.</span> <span class="nx">$recipientsCharset</span> <span class="p">.</span> <span class="dl">'</span><span class="s1">?B?</span><span class="dl">'</span><span class="p">.</span><span class="nx">base64_encode</span><span class="p">(</span><span class="nx">$regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="dl">'</span><span class="s1">?= &lt;</span><span class="dl">'</span><span class="p">.</span><span class="nx">$regs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="dl">'</span><span class="s1">&gt;</span><span class="dl">'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">$recipient</span><span class="p">;</span>
<span class="p">}</span>

</pre></table></code></div></div><p><strong>optimized (utf8 - subject and body safe) :</strong></p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre><td class="rouge-code"><pre><span class="c1">//index-opt.php</span>
<span class="o">&lt;</span><span class="p">?</span><span class="nx">php</span> <span class="nx">session_start</span><span class="p">();</span><span class="o">=</span><span class="dl">""</span> <span class="nx">require_once</span><span class="o">=</span><span class="dl">""</span> <span class="dl">'</span><span class="s1">google/autoload.php</span><span class="dl">'</span><span class="p">;</span><span class="o">=</span><span class="dl">""</span> <span class="nx">or</span><span class="o">=</span><span class="dl">""</span> <span class="nx">wherever</span><span class="o">=</span><span class="dl">""</span> <span class="nx">autoload</span><span class="p">.</span><span class="nx">php</span><span class="o">=</span><span class="dl">""</span> <span class="nx">is</span><span class="o">=</span><span class="dl">""</span> <span class="nx">located</span><span class="o">=</span><span class="dl">""</span> <span class="nx">$client</span><span class="o">=</span><span class="dl">"</span><span class="s2">new</span><span class="dl">"</span> <span class="nx">google_client</span><span class="p">();</span><span class="o">=</span><span class="dl">""</span> <span class="nx">your</span><span class="o">=</span><span class="dl">""</span> <span class="nx">gmail</span><span class="o">=</span><span class="dl">""</span> <span class="nx">tied</span><span class="o">=</span><span class="dl">""</span> <span class="nx">clientid</span><span class="o">=</span><span class="dl">""</span> <span class="p">(</span><span class="nx">aka</span><span class="o">=</span><span class="dl">""</span> <span class="nx">google</span><span class="o">=</span><span class="dl">""</span> <span class="nx">console</span><span class="p">)</span><span class="o">=</span><span class="dl">""</span> <span class="nx">$client</span><span class="o">-=</span><span class="dl">""</span><span class="p">?</span><span class="o">&gt;</span><span class="nx">setClientId</span><span class="p">(</span><span class="dl">"</span><span class="s2">x-y.apps.googleusercontent.com</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setClientSecret</span><span class="p">(</span><span class="dl">"</span><span class="s2">x</span><span class="dl">"</span><span class="p">);</span>
<span class="c1">//your gmail tied ClientId (aka Google Console)</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setRedirectUri</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.x.com/pipis2</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setAccessType</span><span class="p">(</span><span class="dl">'</span><span class="s1">offline</span><span class="dl">'</span><span class="p">);</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setApprovalPrompt</span><span class="p">(</span><span class="dl">'</span><span class="s1">force</span><span class="dl">'</span><span class="p">);</span>

	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://mail.google.com/</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.googleapis.com/auth/gmail.compose</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.googleapis.com/auth/gmail.modify</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.googleapis.com/auth/gmail.readonly</span><span class="dl">"</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nx">$_REQUEST</span><span class="p">[</span><span class="dl">'</span><span class="s1">code</span><span class="dl">'</span><span class="p">]))</span> <span class="p">{</span>
	<span class="c1">//land when user authenticated</span>
	<span class="nx">$code</span> <span class="o">=</span> <span class="nx">$_REQUEST</span><span class="p">[</span><span class="dl">'</span><span class="s1">code</span><span class="dl">'</span><span class="p">];</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">authenticate</span><span class="p">(</span><span class="nx">$code</span><span class="p">);</span>

	<span class="nx">$_SESSION</span><span class="p">[</span><span class="dl">'</span><span class="s1">gmail_access_token</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">getAccessToken</span><span class="p">();</span>

	<span class="nx">header</span><span class="p">(</span><span class="dl">"</span><span class="s2">Location: https://www.x.com/pipis2</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//$isAccessCodeExpired = $client-&gt;isAccessTokenExpired();</span>

<span class="c1">//if (isset($_SESSION['gmail_access_token']) &amp;&amp; !empty($_SESSION['gmail_access_token']) &amp;&amp; $isAccessCodeExpired != 1) {</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nx">$_SESSION</span><span class="p">[</span><span class="dl">'</span><span class="s1">gmail_access_token</span><span class="dl">'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">empty</span><span class="p">(</span><span class="nx">$_SESSION</span><span class="p">[</span><span class="dl">'</span><span class="s1">gmail_access_token</span><span class="dl">'</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>

    <span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setAccessToken</span><span class="p">(</span><span class="nx">$_SESSION</span><span class="p">[</span><span class="dl">'</span><span class="s1">gmail_access_token</span><span class="dl">'</span><span class="p">]);</span>            
    <span class="nx">$objGMail</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Google_Service_Gmail</span><span class="p">(</span><span class="nx">$client</span><span class="p">);</span>

    <span class="nx">$strSubject</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Αυτό είναι Test mail using GMail API</span><span class="dl">'</span> <span class="p">.</span> <span class="nx">date</span><span class="p">(</span><span class="dl">'</span><span class="s1">M d, Y h:i:s A</span><span class="dl">'</span><span class="p">);</span>

	<span class="nx">$strRawMessage</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">From: Human Test &lt;joe@gmail.com&gt;</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
	<span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">"</span><span class="s2">To: 93 Robot &lt;joe@yahoo.com&gt;</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">'</span><span class="s1">Subject: =?utf-8?B?</span><span class="dl">'</span> <span class="p">.</span> <span class="nx">base64_encode</span><span class="p">(</span><span class="nx">$strSubject</span><span class="p">)</span> <span class="p">.</span> <span class="dl">"</span><span class="s2">?=</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
	<span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">"</span><span class="s2">MIME-Version: 1.0</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
	<span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">"</span><span class="s2">Content-Type: text/html; charset=utf-8</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
	<span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">'</span><span class="s1">Content-Transfer-Encoding: quoted-printable</span><span class="dl">'</span> <span class="p">.</span> <span class="dl">"</span><span class="se">\r\n\r\n</span><span class="dl">"</span><span class="p">;</span>
	<span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">"</span><span class="s2">this **is a** τηισ είς α τεστ tes2t!</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>

    <span class="c1">//Users.messages-&gt;send - Requires -&gt; Prepare the message in message/rfc822</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// The message needs to be encoded in Base64URL</span>
        <span class="nx">$mime</span> <span class="o">=</span> <span class="nx">rtrim</span><span class="p">(</span><span class="nx">strtr</span><span class="p">(</span><span class="nx">base64_encode</span><span class="p">(</span><span class="nx">$strRawMessage</span><span class="p">),</span> <span class="dl">'</span><span class="s1">+/</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">-_</span><span class="dl">'</span><span class="p">),</span> <span class="dl">'</span><span class="s1">=</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">$msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Google_Service_Gmail_Message</span><span class="p">();</span>
        <span class="nx">$msg</span><span class="o">-&gt;</span><span class="nx">setRaw</span><span class="p">(</span><span class="nx">$mime</span><span class="p">);</span>

        <span class="c1">//The special value **me** can be used to indicate the authenticated user.</span>
        <span class="nx">$objSentMsg</span> <span class="o">=</span> <span class="nx">$objGMail</span><span class="o">-&gt;</span><span class="nx">users_messages</span><span class="o">-&gt;</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">me</span><span class="dl">"</span><span class="p">,</span> <span class="nx">$msg</span><span class="p">);</span>

        <span class="nx">print</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message sent object</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">print</span><span class="p">(</span><span class="nx">$objSentMsg</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">$e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">print</span><span class="p">(</span><span class="nx">$e</span><span class="o">-&gt;</span><span class="nx">getMessage</span><span class="p">());</span>
        <span class="nx">unset</span><span class="p">(</span><span class="nx">$_SESSION</span><span class="p">[</span><span class="dl">'</span><span class="s1">gmail_access_token</span><span class="dl">'</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Failed Authentication</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nx">$_REQUEST</span><span class="p">[</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="c1">//header('Location: ./index.php?error_code=1');</span>
        <span class="nx">echo</span> <span class="dl">"</span><span class="s2">error auth</span><span class="dl">"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="c1">// Redirects to google for User Authentication</span>
        <span class="nx">$authUrl</span> <span class="o">=</span> <span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">createAuthUrl</span><span class="p">();</span>
        <span class="nx">header</span><span class="p">(</span><span class="dl">"</span><span class="s2">Location: $authUrl</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><hr /><p>Automate process (no user interaction) :</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setAccessType</span><span class="p">(</span><span class="dl">'</span><span class="s1">offline</span><span class="dl">'</span><span class="p">);</span>
	<span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setApprovalPrompt</span><span class="p">(</span><span class="dl">'</span><span class="s1">force</span><span class="dl">'</span><span class="p">);</span>
</pre></table></code></div></div><p>source - <a href="http://developers.google.com/accounts/docs/OAuth2WebServer#offline">http://developers.google.com/accounts/docs/OAuth2WebServer#offline</a></p><p>In some cases, your application may need to <strong>access a Google API when the user is not present</strong>. Examples of this include backup services and applications that make blogger posts exactly at 8am on Monday morning. This style of access is called offline, and web server applications may request offline access from a user. The normal and default style of access is called online.</p><p>If is the first time the application has exchanged an authorization code for a user, then the response includes an access token and a refresh token, as shown below:</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="p">{</span>
  <span class="dl">"</span><span class="s2">access_token</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">1/fFAGRNJru1FTz70BzhT3Zg</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">expires_in</span><span class="dl">"</span><span class="p">:</span><span class="mi">3920</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">token_type</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Bearer</span><span class="dl">"</span><span class="p">,</span>
  <span class="dl">"</span><span class="s2">refresh_token</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">1/xEoDL4iW3cxlI7yDbSRFYNG01kVKM2C-259HOF2aQbI</span><span class="dl">"</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Important: When your application receives a refresh token, it is important to <strong>store that refresh token for future use. If your application loses the refresh token, it will have to re-prompt the user for consent before obtaining another refresh token.</strong> If you need to re-prompt the user for consent, include the approval_prompt parameter in the authorization code request, and set the value to force.</p><p>^apply to code :</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre><td class="rouge-code"><pre><span class="c1">//index-opt-automated.php</span>
<span class="o">&lt;</span><span class="p">?</span><span class="nx">php</span> <span class="nx">session_start</span><span class="p">();</span><span class="o">=</span><span class="dl">""</span> <span class="nx">require_once</span><span class="o">=</span><span class="dl">""</span> <span class="dl">'</span><span class="s1">google/autoload.php</span><span class="dl">'</span><span class="p">;</span><span class="o">=</span><span class="dl">""</span> <span class="nx">or</span><span class="o">=</span><span class="dl">""</span> <span class="nx">wherever</span><span class="o">=</span><span class="dl">""</span> <span class="nx">autoload</span><span class="p">.</span><span class="nx">php</span><span class="o">=</span><span class="dl">""</span> <span class="nx">is</span><span class="o">=</span><span class="dl">""</span> <span class="nx">located</span><span class="o">=</span><span class="dl">""</span> <span class="nx">$client</span><span class="o">=</span><span class="dl">"</span><span class="s2">new</span><span class="dl">"</span> <span class="nx">google_client</span><span class="p">();</span><span class="o">=</span><span class="dl">""</span> <span class="nx">your</span><span class="o">=</span><span class="dl">""</span> <span class="nx">gmail</span><span class="o">=</span><span class="dl">""</span> <span class="nx">tied</span><span class="o">=</span><span class="dl">""</span> <span class="nx">clientid</span><span class="o">=</span><span class="dl">""</span> <span class="p">(</span><span class="nx">aka</span><span class="o">=</span><span class="dl">""</span> <span class="nx">google</span><span class="o">=</span><span class="dl">""</span> <span class="nx">console</span><span class="p">)</span><span class="o">=</span><span class="dl">""</span> <span class="nx">$client</span><span class="o">-=</span><span class="dl">""</span><span class="p">?</span><span class="o">&gt;</span><span class="nx">setClientId</span><span class="p">(</span><span class="dl">"</span><span class="s2">x-y.apps.googleusercontent.com</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setClientSecret</span><span class="p">(</span><span class="dl">"</span><span class="s2">x</span><span class="dl">"</span><span class="p">);</span>
<span class="c1">//your gmail tied ClientId (aka Google Console)</span>
    <span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setRedirectUri</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.x.com/pipis2</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setAccessType</span><span class="p">(</span><span class="dl">'</span><span class="s1">offline</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setApprovalPrompt</span><span class="p">(</span><span class="dl">'</span><span class="s1">force</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://mail.google.com/</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.googleapis.com/auth/gmail.compose</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.googleapis.com/auth/gmail.modify</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">addScope</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.googleapis.com/auth/gmail.readonly</span><span class="dl">"</span><span class="p">);</span>

<span class="c1">//if (isset($_REQUEST['code'])) {</span>
<span class="c1">//    //land when user authenticated</span>
<span class="c1">//    $code = $_REQUEST['code'];</span>
<span class="c1">//    $client-&gt;authenticate($code);</span>
<span class="c1">// </span>
<span class="c1">//    $_SESSION['gmail_access_token'] = $client-&gt;getAccessToken();</span>
<span class="c1">// </span>
<span class="c1">//	echo $_SESSION['gmail_access_token'];</span>
<span class="c1">//	exit;</span>
<span class="c1">//    header("Location: https://www.x.com/pipis2");</span>
<span class="c1">//}</span>

<span class="nx">$_SESSION</span><span class="p">[</span><span class="dl">'</span><span class="s1">gmail_access_token</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">{"access_token":"x.y-t-o","token_type":"Bearer","expires_in":3600,"refresh_token":"a</span><span class="se">\</span><span class="s1">/n-m","created":-9}</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">//$isAccessCodeExpired = $client-&gt;isAccessTokenExpired();</span>

<span class="c1">//if (isset($_SESSION['gmail_access_token']) &amp;&amp; !empty($_SESSION['gmail_access_token']) &amp;&amp; $isAccessCodeExpired != 1) {</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nx">$_SESSION</span><span class="p">[</span><span class="dl">'</span><span class="s1">gmail_access_token</span><span class="dl">'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">empty</span><span class="p">(</span><span class="nx">$_SESSION</span><span class="p">[</span><span class="dl">'</span><span class="s1">gmail_access_token</span><span class="dl">'</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>

    <span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">setAccessToken</span><span class="p">(</span><span class="nx">$_SESSION</span><span class="p">[</span><span class="dl">'</span><span class="s1">gmail_access_token</span><span class="dl">'</span><span class="p">]);</span>
    <span class="nx">$objGMail</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Google_Service_Gmail</span><span class="p">(</span><span class="nx">$client</span><span class="p">);</span>

    <span class="nx">$strSubject</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Αυτό είναι Test mail using GMail API</span><span class="dl">'</span> <span class="p">.</span> <span class="nx">date</span><span class="p">(</span><span class="dl">'</span><span class="s1">M d, Y h:i:s A</span><span class="dl">'</span><span class="p">);</span>

    <span class="nx">$strRawMessage</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">From: Human Test &lt;joe@gmail.com&gt;</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">"</span><span class="s2">To: 93 Robot &lt;joe@yahoo.com&gt;</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">'</span><span class="s1">Subject: =?utf-8?B?</span><span class="dl">'</span> <span class="p">.</span> <span class="nx">base64_encode</span><span class="p">(</span><span class="nx">$strSubject</span><span class="p">)</span> <span class="p">.</span> <span class="dl">"</span><span class="s2">?=</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">"</span><span class="s2">MIME-Version: 1.0</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">"</span><span class="s2">Content-Type: text/html; charset=utf-8</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">'</span><span class="s1">Content-Transfer-Encoding: quoted-printable</span><span class="dl">'</span> <span class="p">.</span> <span class="dl">"</span><span class="se">\r\n\r\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">$strRawMessage</span> <span class="p">.</span><span class="o">=</span> <span class="dl">"</span><span class="s2">this **is a** τηισ είς α τεστ tes2t!</span><span class="se">\r\n</span><span class="dl">"</span><span class="p">;</span>

    <span class="c1">//Users.messages-&gt;send - Requires -&gt; Prepare the message in message/rfc822</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// The message needs to be encoded in Base64URL</span>
        <span class="nx">$mime</span> <span class="o">=</span> <span class="nx">rtrim</span><span class="p">(</span><span class="nx">strtr</span><span class="p">(</span><span class="nx">base64_encode</span><span class="p">(</span><span class="nx">$strRawMessage</span><span class="p">),</span> <span class="dl">'</span><span class="s1">+/</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">-_</span><span class="dl">'</span><span class="p">),</span> <span class="dl">'</span><span class="s1">=</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">$msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Google_Service_Gmail_Message</span><span class="p">();</span>
        <span class="nx">$msg</span><span class="o">-&gt;</span><span class="nx">setRaw</span><span class="p">(</span><span class="nx">$mime</span><span class="p">);</span>

        <span class="c1">//The special value **me** can be used to indicate the authenticated user.</span>
        <span class="nx">$objSentMsg</span> <span class="o">=</span> <span class="nx">$objGMail</span><span class="o">-&gt;</span><span class="nx">users_messages</span><span class="o">-&gt;</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">me</span><span class="dl">"</span><span class="p">,</span> <span class="nx">$msg</span><span class="p">);</span>

        <span class="nx">print</span><span class="p">(</span><span class="dl">'</span><span class="s1">Message sent object</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">print</span><span class="p">(</span><span class="nx">$objSentMsg</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nx">$e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">print</span><span class="p">(</span><span class="nx">$e</span><span class="o">-&gt;</span><span class="nx">getMessage</span><span class="p">());</span>
        <span class="nx">unset</span><span class="p">(</span><span class="nx">$_SESSION</span><span class="p">[</span><span class="dl">'</span><span class="s1">gmail_access_token</span><span class="dl">'</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Failed Authentication</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nx">$_REQUEST</span><span class="p">[</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="c1">//header('Location: ./index.php?error_code=1');</span>
        <span class="nx">echo</span> <span class="dl">"</span><span class="s2">error auth</span><span class="dl">"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="c1">// Redirects to google for User Authentication</span>
        <span class="nx">$authUrl</span> <span class="o">=</span> <span class="nx">$client</span><span class="o">-&gt;</span><span class="nx">createAuthUrl</span><span class="p">();</span>
        <span class="nx">header</span><span class="p">(</span><span class="dl">"</span><span class="s2">Location: $authUrl</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="p">?</span><span class="o">&gt;</span>
</pre></table></code></div></div><p>1-line 29+30 : we run it once to get the ‘access token and a refresh token’ 2-we remark 22-32 and set to a session variable the ‘access token and a refresh token’ we got at step1&lt;/joe@yahoo.com&gt;&lt;/joe@gmail.com&gt;&lt;/joe@yahoo.com&gt;&lt;/joe@gmail.com&gt;&lt;/’.$regs[2].’&gt;&lt;/(.*)&gt;&lt;/’&gt;&lt;/”&gt;&lt;/”&gt;</p><p>origin - http://www.pipiscrew.com/?p=2773 php-send-mail-through-gmail-api</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/php/'>php</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=send mail through Gmail API - PipisCrew&url=/posts/send-mail/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=send mail through Gmail API - PipisCrew&u=/posts/send-mail/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=send mail through Gmail API - PipisCrew&url=/posts/send-mail/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/proper-con/"><div class="card-body"> <span class="timeago small" > Jun 23, 2017 <i class="unloaded">2017-06-23T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Proper convert UTC to Browser time</h3><div class="text-muted small"><p> 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 //src - //https://stackoverfl...</p></div></div></a></div><div class="card"> <a href="/posts/php-androi/"><div class="card-body"> <span class="timeago small" > Jun 24, 2017 <i class="unloaded">2017-06-24T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>o[php android .net] Encryption - AES128 PKCS7</h3><div class="text-muted small"><p> references : http://aesencryption.net/ https://zenu.wordpress.com/2011/09/21/aes-128bit-cross-platform-java-and-c-encryption-compatibility/ https://gist.github.com/jafetsanchez/1080133 http://vivav...</p></div></div></a></div><div class="card"> <a href="/posts/prevent-sq/"><div class="card-body"> <span class="timeago small" > Jun 27, 2017 <i class="unloaded">2017-06-27T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Prevent SQL Injection Vulnerabilities in PHP Applications and Fix Them</h3><div class="text-muted small"><p> https://dzone.com/articles/prevent-sql-injection-vulnerabilities-in-php-appli origin - http://www.pipiscrew.com/2017/06/prevent-sql-injection-vulnerabilities-in-php-applications-and-fix-them/ prev...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/lucky-dube/" class="btn btn-outline-primary"><p>Lucky Dube</p></a> <a href="/posts/android-im/" class="btn btn-outline-primary"><p>Android implement G/FB/TW login via socialauth-android library</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2020 <a href="https://twitter.com/pipiscrew">pipiscrew</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
